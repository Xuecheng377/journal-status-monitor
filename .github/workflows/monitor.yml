name: æœŸåˆŠçŠ¶æ€ç›‘æ§

on:
 on:
  schedule:
    # åŒ—äº¬æ—¶é—´ 9:00 - æ¯æ—¥æŠ¥å‘Šï¼ˆUTC 1:00ï¼‰
    - cron: '0 1 * * *'
    # åŒ—äº¬æ—¶é—´ 13:00 - åªåœ¨æœ‰å˜åŒ–æ—¶é€šçŸ¥ï¼ˆUTC 5:00ï¼‰
    - cron: '0 5 * * *'
    # åŒ—äº¬æ—¶é—´ 22:00 - åªåœ¨æœ‰å˜åŒ–æ—¶é€šçŸ¥ï¼ˆUTC 14:00ï¼‰
    - cron: '0 14 * * *'
  
  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼'
        required: true
        default: 'normal'
        type: choice
        options:
          - normal
          - test
          - daily_report

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: åˆ›å»ºå¿…è¦ç›®å½•
        run: |
          mkdir -p data logs
      
      - name: æ‰§è¡Œç›‘æ§ä»»åŠ¡
        env:
          IEEE_EMAIL: ${{ secrets.IEEE_EMAIL }}
          IEEE_PASSWORD: ${{ secrets.IEEE_PASSWORD }}
          IEEE_URL: ${{ secrets.IEEE_URL }}
          ELSEVIER_EMAIL: ${{ secrets.ELSEVIER_EMAIL }}
          ELSEVIER_PASSWORD: ${{ secrets.ELSEVIER_PASSWORD }}
          ELSEVIER_URL: ${{ secrets.ELSEVIER_URL }}
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECEIVER: ${{ secrets.EMAIL_RECEIVER }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          LOG_LEVEL: INFO
          DATA_FILE: data/manuscripts.json
          HEADLESS: true
        run: |
          MODE="${{ github.event.inputs.mode || 'normal' }}"
          CURRENT_HOUR=$(TZ='Asia/Shanghai' date '+%H')
          
          echo "=========================================="
          echo "è¿è¡Œæ¨¡å¼: $MODE"
          echo "æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          echo "å½“å‰å°æ—¶: $CURRENT_HOUR"
          echo "=========================================="
          
          if [ "$MODE" = "test" ]; then
            echo "ğŸ§ª æµ‹è¯•æ¨¡å¼ï¼šå‘é€æµ‹è¯•é‚®ä»¶"
            python -c "from notification import EmailNotifier; EmailNotifier().send_test_email()"
          elif [ "$MODE" = "daily_report" ]; then
            echo "ğŸ“Š æ¯æ—¥æŠ¥å‘Šæ¨¡å¼ï¼šæ— è®ºæ˜¯å¦æœ‰å˜åŒ–éƒ½å‘é€é‚®ä»¶"
            export DAILY_REPORT=true
            python monitor.py
          else
            echo "ğŸš€ æ­£å¸¸æ¨¡å¼ï¼šæ‰§è¡Œç›‘æ§ä»»åŠ¡"
            # åˆ¤æ–­æ˜¯å¦ä¸ºåŒ—äº¬æ—¶é—´9:00ï¼ˆæ¯æ—¥æŠ¥å‘Šæ—¶é—´ï¼‰
            if [ "$CURRENT_HOUR" = "09" ]; then
              echo "ğŸ“Š æ¯æ—¥æŠ¥å‘Šæ—¶é—´ï¼šå‘é€æ‰€æœ‰ç¨¿ä»¶çŠ¶æ€"
              export DAILY_REPORT=true
            else
              echo "ğŸ” æ™®é€šç›‘æ§ï¼šåªåœ¨çŠ¶æ€å˜åŒ–æ—¶å‘é€é‚®ä»¶"
              export DAILY_REPORT=false
            fi
            python monitor.py
          fi
      
      - name: æäº¤æ•°æ®æ–‡ä»¶å˜åŒ–
        if: always()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/manuscripts.json || true
          if git diff --staged --quiet; then
            echo "â„¹ï¸  æ•°æ®æ–‡ä»¶æ— å˜åŒ–"
          else
            git commit -m "Update manuscript status data [skip ci]"
            git push
            echo "âœ… æ•°æ®æ–‡ä»¶å·²æ›´æ–°"
          fi
