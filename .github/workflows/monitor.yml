name: æœŸåˆŠçŠ¶æ€ç›‘æ§

on:
  schedule:
    - cron: '0 1,9,17 * * *'  # UTCæ—¶é—´ 1:00, 9:00, 17:00 (åŒ—äº¬æ—¶é—´ 9:00, 17:00, 1:00)
  
  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼'
        required: true
        default: 'normal'
        type: choice
        options:
          - normal
          - test

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: åˆ›å»ºå¿…è¦ç›®å½•
        run: |
          mkdir -p data logs
      
      - name: æ‰§è¡Œç›‘æ§ä»»åŠ¡
        env:
          IEEE_EMAIL: ${{ secrets.IEEE_EMAIL }}
          IEEE_PASSWORD: ${{ secrets.IEEE_PASSWORD }}
          IEEE_URL: ${{ secrets.IEEE_URL }}
          ELSEVIER_EMAIL: ${{ secrets.ELSEVIER_EMAIL }}
          ELSEVIER_PASSWORD: ${{ secrets.ELSEVIER_PASSWORD }}
          ELSEVIER_URL: ${{ secrets.ELSEVIER_URL }}
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECEIVER: ${{ secrets.EMAIL_RECEIVER }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          LOG_LEVEL: INFO
          DATA_FILE: data/manuscripts.json
          HEADLESS: true
        run: |
          MODE="${{ github.event.inputs.mode || 'normal' }}"
          
          echo "=========================================="
          echo "è¿è¡Œæ¨¡å¼: $MODE"
          echo "æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          echo "=========================================="
          
          if [ "$MODE" = "test" ]; then
            echo "ğŸ§ª æµ‹è¯•æ¨¡å¼ï¼šå‘é€æµ‹è¯•é‚®ä»¶"
            python -c "from notification import EmailNotifier; EmailNotifier().send_test_email()"
          else
            echo "ğŸš€ æ­£å¸¸æ¨¡å¼ï¼šæ‰§è¡Œç›‘æ§ä»»åŠ¡"
            python monitor.py
          fi
      
      - name: æäº¤æ•°æ®æ–‡ä»¶å˜åŒ–
        if: always()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/manuscripts.json || true
          if git diff --staged --quiet; then
            echo "â„¹ï¸  æ•°æ®æ–‡ä»¶æ— å˜åŒ–"
          else
            git commit -m "Update manuscript status data [skip ci]"
            git push
            echo "âœ… æ•°æ®æ–‡ä»¶å·²æ›´æ–°"
          fi
